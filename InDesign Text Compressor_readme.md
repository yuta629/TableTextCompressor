# **InDesign Text Compressor (TableTextCompressor.jsx)**

Adobe InDesign用のテキスト長体自動調整スクリプトです。  
表組みのセルやテキストボックスから溢れたテキストを、指定した条件（あふれ解消や指定行数）に合わせて自動的に水平比率（長体）を調整して収めます。

## **🌟 特徴**

* **3つの選択モードに対応**: 「表セル」「テキストボックス」「テキスト（段落）」のいずれを選択していても、状況を自動判定して動作します。  
* **スマートな自動調整**:  
  * **オートモード**: 文字あふれ（オーバーフロー）が解消されるギリギリまで長体をかけます。  
  * **行数指定モード**: 「1行に収める」など、指定した行数になるよう長体をかけます。  
* **先頭文字保護**: 箇条書きのビュレット（・）や番号付きリストなど、段落の先頭文字だけ変形させずに残すことができます。  
* **安全性重視の設計**:  
  * **40%制限 & ロールバック**: 変形率は最小40%まで。それ以上圧縮しても収まらない場合は、中途半端に変更せず処理前の状態に戻します。  
  * **連結フレーム警告**: 連結テキストフレームが含まれる場合は警告を表示し、ストーリー全体への予期せぬ影響を防ぎます。  
* **高速処理**: InDesignの再計算（Recompose）頻度を最適化し、大量のセル処理でも実用的な速度で動作します。

## **📦 動作環境**

* Adobe InDesign (CS6 / CC 以降推奨)  
* macOS / Windows  
* ExtendScript (ES3準拠)

## **📥 インストール方法**

1. このリポジトリから TableTextCompressor.jsx をダウンロードします。  
2. InDesignのスクリプトフォルダにファイルを配置します。  
   * **macOS**: /Applications/Adobe InDesign \[Version\]/Scripts/Scripts Panel/  
   * **Windows**: C:\\Program Files\\Adobe\\Adobe InDesign \[Version\]\\Scripts\\Scripts Panel\\

*(ヒント: InDesignの「スクリプト」パネルメニューから「エクスプローラー/Finderで表示」を選択すると素早くフォルダを開けます)*

## **🚀 使い方**

1. **対象を選択します**  
   * **表セル**: 調整したいセルを選択します（複数選択可）。  
   * **テキストボックス**: 黒矢印ツール等でフレームを選択します（複数選択可）。  
   * **テキスト**: 文字ツールで調整したい段落範囲を選択します。  
2. **スクリプトを実行します**  
   * スクリプトパネルから TableTextCompressor.jsx をダブルクリックします。  
3. **設定を行い実行します**  
   * 表示されるダイアログで条件を設定し、「実行」をクリックします。

### **設定項目の詳細**

#### **1\. 文字あふれ処理**

* **オート：あふれ解消を優先** (推奨)  
  * チェックを入れると、文字あふれ（オーバーフロー）が解消されるまで自動的に長体をかけます。  
  * あふれていない場合は現状を維持するか、下記の「目標行数設定」に従います。  
* **OFF（行数指定モード）**  
  * あふれの有無に関わらず、指定した「目標行数」になるよう調整します。

#### **2\. 目標行数設定**

* オートOFF時、またはあふれていない場合に、この行数に収まるまで長体をかけます。  
  * *例: 「1」に設定すると、2行以上になっているテキストを1行に収めます。*

#### **3\. 段落先頭文字の処理**

* **全ての文字を変形する**: 段落全体に均等に長体をかけます。  
* **段落の先頭文字は変形しない**: 先頭の1文字だけ比率を維持（100%または元の比率）し、2文字目以降を圧縮します。

#### **4\. 【テキストボックス選択時のみ】先頭文字リセットモード**

* **ストーリー全段落の先頭文字を100%にする**  
  * このオプションをONにすると、長体調整は行いません。  
  * 連結されたストーリー全体の全段落の先頭文字を強制的に「水平比率100%」に戻します。  
  * *用途: 連結フレーム操作時に先頭文字保護が漏れてしまった箇所の修正など。*

## **⚠️ 仕様と注意点**

### **変形率の制限 (40%)**

可読性を損なう極端な変形を防ぐため、最小変形率は **40%** に設定されています。40%まで圧縮しても「あふれが解消しない」または「目標行数に収まらない」場合は、**スキップ（変更なし）** と判定され、変形率は処理前の値に戻されます。

### **連結テキストフレームの挙動**

* テキストボックス選択時に連結フレームが含まれている場合、実行前に警告ダイアログが表示されます。  
* 処理を実行すると、選択していないフレームも含めた\*\*ストーリー全体（連結された全てのテキスト）\*\*が変形対象となります。  
* 行数指定モードの場合、「選択したフレーム内の行数」を基準に判定を行います。

## **📜 バージョン履歴**

* **v3.12**: グローバルスコープ汚染防止のための内部構造修正。  
* **v3.11**: 「先頭文字リセットモード」の追加。  
* **v3.10**: ロールバック処理の安全性向上（再構成処理の適正化）。  
* **v3.9**: 連結フレーム操作時の警告機能追加。  
* **v3.8**: テキストボックス処理のロジック改善（parentStory対応により、あふれた不可視テキストも処理可能に）。  
* **v3.7**: コードのリファクタリング（共通処理化）。  
* **v3.6**: ロールバック機能（失敗時に元に戻す）の実装、最小変形率を40%に変更。  
* **v3.5**: パフォーマンスチューニング（Recompose呼び出し頻度の最適化）。  
* **v3.4**: オートロジック修正（判定精度の向上）。

## **📄 ライセンス**

このソフトウェアは [MIT License](https://www.google.com/search?q=LICENSE) の下で公開されています。